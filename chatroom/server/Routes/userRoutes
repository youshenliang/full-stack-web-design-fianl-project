const router = require('express').Router();
const bodyParser = require('body-parser');
const userSQLModel = require('../Model/userSQLModel');
const path = require('path');

// 設定requset body parser
var urlencodeParser = bodyParser.urlencoded({extended: false});

var USER_ID = -1;

router.get('/', (req, res) => {
    res.sendFile(path.resolve('client.htm'));
})

router.post('/', urlencodeParser, (req, res) => {
    // 檢查此user是否存在於database內
    // 若有則撈出他的userID；若無則跳轉至註冊畫面(這邊為了方便測試直接塞入db並抓取userID)
    userName = req.body.userName;
    userSQLModel.UserLoginQuery(userName).then((userID) => {
        USER_ID = userID;
        if (userID > 0) res.redirect(301, `http://localhost:3000/chatroom?username=${userName}`);
        else res.status(200).send(`新使用者${userName}註冊成功！請重新登入`);
    }).catch((err) => {
        console.log(`err when user login: ${err.message}`);
        throw (err);
    })
})

router.get('/chatroom', (req, res) => {
    console.log("userID: ", USER_ID);
    // 檢查是否已經登入 (這邊之後要改成cookie之類的方法比較好)
    if(USER_ID != -1) res.sendFile(path.resolve('../client/chatroom.htm'));
    else res.status(403).send("請先登入才能進入聊天室");
})

module.exports = router;